<?php
	use fruithost\Storage\Database;
	
	class ProtectedDirectorysDaemon {
		public function __construct() {
			$entries = $this->getEntries('AND
										`' . DATABASE_PREFIX . 'protected_directorys`.`time_created` IS NULL
									AND
										`' . DATABASE_PREFIX . 'protected_directorys`.`time_deleted` IS NULL');
										
			foreach($entries AS $entry) {
				print 'Create VHost Configuration for ' . $entry->id . PHP_EOL;
				
				$path = sprintf('%s%s%s', HOST_PATH, $entry->username, $entry->path);
				
				if(file_exists($path)) {
					$this->createConfiguration($entry, $path);
				}
			}
			
			$this->reloadApache();
		}
		
		protected function getEntries($sql = '') {
			return Database::fetch('SELECT
										`' . DATABASE_PREFIX . 'protected_directorys`.*,
										`' . DATABASE_PREFIX . 'users`.`username` AS `username`
									FROM
										`' . DATABASE_PREFIX . 'protected_directorys`,
										`' . DATABASE_PREFIX . 'users`
									WHERE
										`' . DATABASE_PREFIX . 'users`.`id`=`' . DATABASE_PREFIX . 'protected_directorys`.`user_id`
									' . $sql . '
									ORDER BY `' . DATABASE_PREFIX . 'protected_directorys`.`id` ASC', []);
		}
		
		protected function createConfiguration($entry, $path) {
			$config = '# Generated by fruithost' . PHP_EOL;
			$config .= sprintf('DefineExternalAuth ProtectedDirectory_%1$d pipe \'/usr/bin/php -q /etc/fruithost/modules/protected-directorys/auth.php %1$d\'', $entry->id) . PHP_EOL;
			$config .= PHP_EOL;
			$config .= sprintf('<Directory %s>', $path) . PHP_EOL;
			$config .= TAB . 'AuthType Basic' . PHP_EOL;
			$config .= TAB . sprintf('AuthName "%s"', $entry->message) . PHP_EOL;
			$config .= TAB . 'AuthBasicProvider external' . PHP_EOL;
			$config .= TAB . sprintf('AuthExternal ProtectedDirectory_%1$d', $entry->id) . PHP_EOL;
			$config .= TAB . 'Require valid-user' . PHP_EOL;
			$config .= '</Directory>' . PHP_EOL;
			
			file_put_contents(sprintf('/etc/fruithost/config/apache2/vhosts/99_%s.%s.protected.conf', $entry->username, $entry->id), $config);
			
			Database::update(DATABASE_PREFIX . 'protected_directorys', 'id', [
				'id'			=> $entry->id,
				'time_created'	=> date('Y-m-d H:i:s', time())
			]);
		}
		
		protected function reloadApache() {
			print shell_exec('service apache2 reload');
		}
	}
	
	new ProtectedDirectorysDaemon();
?>